<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Environment Check - PreoCrypto</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { color: #0055ff; margin-top: 0; }
    h2 { color: #333; margin-top: 0; }
    .status { 
      padding: 8px 16px; 
      border-radius: 4px; 
      display: inline-block;
      font-weight: 600;
      margin-bottom: 16px;
    }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.warning { background: #fff3cd; color: #856404; }
    pre {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 4px;
      overflow-x: auto;
      border: 1px solid #dee2e6;
    }
    button {
      background: #0055ff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover { background: #0044dd; }
    .error-detail { color: #dc3545; margin-top: 10px; }
    .logs { font-size: 12px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>üîç PreoCrypto Environment Checker</h1>
    <p>This tool checks if your PayHero payment integration is properly configured.</p>
    <button onclick="checkConfig()">1. Check Configuration</button>
    <button onclick="testStkPush()">2. Test STK Push</button>
    <button onclick="testCreatePayment()">3. Test Create Payment</button>
    <button onclick="checkAll()">Check All</button>
  </div>

  <div id="results"></div>

  <script>
    async function checkConfig() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<div class="card"><h2>Checking Configuration...</h2><p>‚è≥ Please wait...</p></div>';
      
      try {
        const response = await fetch('/.netlify/functions/test-config');
        const text = await response.text();
        
        let html = '<div class="card"><h2>Configuration Check Results</h2>';
        html += `<div class="status ${response.ok ? 'warning' : 'error'}">Status: ${response.status} ${response.statusText}</div>`;
        
        // Try to parse as JSON
        try {
          const data = JSON.parse(text);
          html += `<div class="status ${data.config?.allEnvVarsSet ? 'success' : 'error'}">`;
          html += data.message || 'Check results';
          html += '</div>';
          
          if (data.config) {
            html += '<h3>Environment Variables Status:</h3>';
            html += '<ul style="text-align: left;">';
            html += `<li>PAYHERO_BASIC_AUTH: ${data.config.hasBasicAuth ? '‚úÖ Set' : '‚ùå Not Set'}</li>`;
            html += `<li>PAYHERO_SECRET_KEY: ${data.config.hasSecretKey ? '‚úÖ Set' : '‚ùå Not Set'}</li>`;
            html += `<li>PAYHERO_ACCOUNT_ID: ${data.config.hasAccountId ? '‚úÖ Set (' + data.config.accountIdPreview + ')' : '‚ùå Not Set'}</li>`;
            html += `<li>PAYHERO_CALLBACK_URL: ${data.config.callbackUrl}</li>`;
            html += '</ul>';
          }
          
          if (data.instructions) {
            html += '<h3>‚ö†Ô∏è Setup Instructions:</h3>';
            html += '<pre style="text-align: left; white-space: pre-wrap;">' + JSON.stringify(data.instructions, null, 2) + '</pre>';
          }
          
          html += '<h3>Full Response:</h3><pre style="text-align: left;">' + JSON.stringify(data, null, 2) + '</pre>';
        } catch (parseErr) {
          html += `<div class="error-detail">‚ùå Server returned HTML instead of JSON. Function may not be deployed.</div>`;
          html += '<h3>Raw Response (first 1000 chars):</h3><pre style="text-align: left; max-height: 300px; overflow: auto;">' + text.substring(0, 1000) + '</pre>';
        }
        
        html += '</div>';
        resultsDiv.innerHTML = html;
      } catch (err) {
        resultsDiv.innerHTML = `<div class="card"><h2>Configuration Check</h2><div class="status error">‚ùå NETWORK ERROR</div><div class="error-detail">${err.message}</div><p>The function may not be deployed yet. Try redeploying your site on Netlify.</p></div>`;
      }
    }

    async function testStkPush() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<div class="card"><h2>Testing STK Push...</h2><p>‚è≥ Please wait...</p></div>';
      
      try {
        const response = await fetch('/api/payment/intent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            phone: '254712345678',
            amount: 100,
            metadata: { test: true }
          })
        });

        const text = await response.text();
        let html = '<div class="card"><h2>STK Push Test Results</h2>';
        html += `<div class="status ${response.ok ? 'success' : 'error'}">Status: ${response.status} ${response.statusText}</div>`;
        
        try {
          const data = JSON.parse(text);
          
          if (!response.ok) {
            html += `<div class="error-detail"><strong>Error:</strong> ${data.error || 'Unknown error'}</div>`;
          }
          
          if (data.logs && data.logs.length > 0) {
            html += '<h3>Diagnostic Logs:</h3><pre class="logs" style="text-align: left;">' + JSON.stringify(data.logs, null, 2) + '</pre>';
          }
          
          html += '<h3>Full Response:</h3><pre style="text-align: left;">' + JSON.stringify(data, null, 2) + '</pre>';
        } catch (parseErr) {
          html += `<div class="error-detail">‚ùå Server returned HTML instead of JSON</div>`;
          html += '<h3>Raw Response (first 1000 chars):</h3><pre style="text-align: left; max-height: 300px; overflow: auto;">' + text.substring(0, 1000) + '</pre>';
        }
        
        html += '</div>';
        resultsDiv.innerHTML = html;
      } catch (err) {
        resultsDiv.innerHTML = `<div class="card"><h2>STK Push Test</h2><div class="status error">‚ùå NETWORK ERROR</div><div class="error-detail">${err.message}</div></div>`;
      }
    }

    async function testCreatePayment() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<div class="card"><h2>Testing Create Payment...</h2><p>‚è≥ Please wait...</p></div>';
      
      try {
        const response = await fetch('/api/payhero/create-payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: 'test@example.com',
            phone: '254712345678',
            amount: 100,
            metadata: { test: true }
          })
        });

        const text = await response.text();
        let html = '<div class="card"><h2>Create Payment Test Results</h2>';
        html += `<div class="status ${response.ok ? 'success' : 'error'}">Status: ${response.status} ${response.statusText}</div>`;
        
        try {
          const data = JSON.parse(text);
          
          if (!response.ok) {
            html += `<div class="error-detail"><strong>Error:</strong> ${data.error || 'Unknown error'}</div>`;
          }
          
          if (data.logs && data.logs.length > 0) {
            html += '<h3>Diagnostic Logs:</h3><pre class="logs" style="text-align: left;">' + JSON.stringify(data.logs, null, 2) + '</pre>';
          }
          
          html += '<h3>Full Response:</h3><pre style="text-align: left;">' + JSON.stringify(data, null, 2) + '</pre>';
        } catch (parseErr) {
          html += `<div class="error-detail">‚ùå Server returned HTML instead of JSON</div>`;
          html += '<h3>Raw Response (first 1000 chars):</h3><pre style="text-align: left; max-height: 300px; overflow: auto;">' + text.substring(0, 1000) + '</pre>';
        }
        
        html += '</div>';
        resultsDiv.innerHTML = html;
      } catch (err) {
        resultsDiv.innerHTML = `<div class="card"><h2>Create Payment Test</h2><div class="status error">‚ùå NETWORK ERROR</div><div class="error-detail">${err.message}</div></div>`;
      }
    }

    async function checkAll() {
      await checkConfig();
      await new Promise(resolve => setTimeout(resolve, 1500));
      const firstResult = document.getElementById('results').innerHTML;
      await testStkPush();
      await new Promise(resolve => setTimeout(resolve, 1000));
      const secondResult = document.getElementById('results').innerHTML;
      await testCreatePayment();
      const thirdResult = document.getElementById('results').innerHTML;
      document.getElementById('results').innerHTML = firstResult + secondResult + thirdResult;
    }
  </script>
</body>
</html>
