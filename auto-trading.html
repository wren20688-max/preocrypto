<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Auto Trading ‚Äî PreoCrypto</title>
  <meta name="description" content="Automated Trading Bot - Let AI trade for you 24/7 with advanced strategies">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='logoGradient1' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%230055ff;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%2300d4ff;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='100' cy='100' r='95' fill='none' stroke='url(%23logoGradient1)' stroke-width='2' opacity='0.3'/%3E%3Cpath d='M 100 30 L 150 60 L 150 130 L 100 160 L 50 130 L 50 60 Z' fill='url(%23logoGradient1)' opacity='0.1'/%3E%3Cg%3E%3Crect x='70' y='95' width='8' height='35' fill='%2300d084' opacity='0.9'/%3E%3Cline x1='74' y1='85' x2='74' y2='135' stroke='%2300d084' stroke-width='2'/%3E%3Crect x='85' y='75' width='8' height='55' fill='%2300d084' opacity='0.95'/%3E%3Cline x1='89' y1='65' x2='89' y2='135' stroke='%2300d084' stroke-width='2'/%3E%3Crect x='100' y='55' width='8' height='75' fill='%230055ff' opacity='1'/%3E%3Cline x1='104' y1='45' x2='104' y2='135' stroke='%230055ff' stroke-width='2'/%3E%3Crect x='115' y='80' width='8' height='50' fill='%2300d4ff' opacity='0.9'/%3E%3Cline x1='119' y1='70' x2='119' y2='135' stroke='%2300d4ff' stroke-width='2'/%3E%3C/g%3E%3C/svg%3E">
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@400;600&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <header class="top-nav">
    <div class="nav-left">
      <button id="menuToggle" class="menu-toggle">‚ò∞</button>
      <div class="logo" style="width: 32px; height: 32px; margin: 0 8px;">
        <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="logoGradient1" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#2563EB;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#22C55E;stop-opacity:1" />
            </linearGradient>
          </defs>
          <circle cx="100" cy="100" r="95" fill="none" stroke="url(#logoGradient1)" stroke-width="2" opacity="0.3"/>
          <path d="M 100 30 L 150 60 L 150 130 L 100 160 L 50 130 L 50 60 Z" fill="url(#logoGradient1)" opacity="0.1"/>
        </svg>
      </div>
      <h1 style="color: var(--text-primary); font-family: 'Inter', 'Poppins', 'Montserrat', sans-serif;">PreoCrypto</h1>
    </div>
    <div class="nav-center">
      <span class="balance-display">Balance: <strong id="balance">$10,000.00</strong></span>
    </div>
    <div class="nav-right">
      <button id="toggleMode" class="nav-btn">Theme</button>
      <a href="index.html" class="nav-btn logout">Logout</a>
    </div>
  </header>

  <nav id="sideMenu" class="side-menu">
    <button class="menu-close">&times;</button>
    <div class="menu-items">
      <a href="dashboard.html" class="menu-item">Dashboard</a>
      <a href="auto-trading.html" class="menu-item active">Auto Trading</a>
      <a href="finances.html" class="menu-item">Finances</a>
      <a href="transactions.html" class="menu-item">Transactions</a>
      <a href="payment-methods.html" class="menu-item">Payment Methods</a>
      <a href="profile.html" class="menu-item">Profile</a>
    </div>
  </nav>

  <main class="main-container page-container">
    <div class="page-header">
      <h2>Automated Trading Bot</h2>
      <p id="botStatus">Status: <span id="botStatusText" style="color:var(--danger);">Stopped</span></p>
    </div>

    <section class="content-card">
      <h3>üéØ Account Selection</h3>
      <div style="display: flex; gap: 15px; margin-bottom: 20px;">
        <button id="demoAccountBtn" class="toggle-btn demo-active" style="flex: 1; padding: 12px; border: 2px solid transparent; border-radius: 8px; background: rgba(0, 212, 255, 0.1); color: #00d4ff; cursor: pointer; font-weight: 600; transition: all 0.3s;" onclick="switchTradingAccount('demo')">üì± Demo Account</button>
        <button id="realAccountBtn" class="toggle-btn" style="flex: 1; padding: 12px; border: 2px solid transparent; border-radius: 8px; background: rgba(100, 100, 100, 0.1); color: #999; cursor: pointer; font-weight: 600; transition: all 0.3s;" onclick="switchTradingAccount('real')">üíé Real Account</button>
      </div>
      <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid #00d4ff;">
        <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 5px;">Trading Account Balance:</div>
        <div style="font-size: 24px; font-weight: bold; color: #00d4ff;" id="tradingAccountBalance">$10,000.00</div>
      </div>
    </section>

    <section class="content-card">h3>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
        <div class="form-group">
          <label>Trading Pair</label>
          <select id="botPair">
            <optgroup label="Major Forex Pairs">
              <option value="EUR/USD">EUR/USD</option>
              <option value="GBP/USD">GBP/USD</option>
              <option value="USD/JPY">USD/JPY</option>
              <option value="AUD/USD">AUD/USD</option>
              <option value="USD/CAD">USD/CAD</option>
              <option value="NZD/USD">NZD/USD</option>
              <option value="USD/CHF">USD/CHF</option>
            </optgroup>
            <optgroup label="Cross Forex Pairs">
              <option value="EUR/GBP">EUR/GBP</option>
              <option value="EUR/JPY">EUR/JPY</option>
              <option value="GBP/JPY">GBP/JPY</option>
              <option value="AUD/JPY">AUD/JPY</option>
              <option value="EUR/CHF">EUR/CHF</option>
              <option value="GBP/CHF">GBP/CHF</option>
              <option value="AUD/CAD">AUD/CAD</option>
              <option value="NZD/CAD">NZD/CAD</option>
              <option value="EUR/AUD">EUR/AUD</option>
              <option value="GBP/AUD">GBP/AUD</option>
              <option value="EUR/NZD">EUR/NZD</option>
              <option value="GBP/NZD">GBP/NZD</option>
              <option value="AUD/NZD">AUD/NZD</option>
              <option value="CAD/JPY">CAD/JPY</option>
              <option value="CHF/JPY">CHF/JPY</option>
            </optgroup>
            <optgroup label="Exotic Forex Pairs">
              <option value="USD/SGD">USD/SGD</option>
              <option value="USD/MXN">USD/MXN</option>
              <option value="USD/ZAR">USD/ZAR</option>
              <option value="USD/TRY">USD/TRY</option>
              <option value="USD/CNY">USD/CNY</option>
              <option value="USD/HKD">USD/HKD</option>
              <option value="USD/INR">USD/INR</option>
              <option value="USD/KRW">USD/KRW</option>
              <option value="USD/SEK">USD/SEK</option>
              <option value="USD/NOK">USD/NOK</option>
              <option value="USD/DKK">USD/DKK</option>
              <option value="USD/PLN">USD/PLN</option>
              <option value="USD/RUB">USD/RUB</option>
            </optgroup>
            <optgroup label="Cryptocurrencies">
              <option value="Bitcoin">Bitcoin (BTC)</option>
              <option value="Ethereum">Ethereum (ETH)</option>
              <option value="XRP">XRP</option>
              <option value="Litecoin">Litecoin (LTC)</option>
              <option value="Cardano">Cardano (ADA)</option>
              <option value="Dogecoin">Dogecoin (DOGE)</option>
            </optgroup>
            <optgroup label="Indices">
              <option value="US30">US30 (Dow Jones)</option>
              <option value="US500">US500 (S&P 500)</option>
              <option value="NAS100">NAS100 (Nasdaq)</option>
              <option value="UK100">UK100 (FTSE)</option>
              <option value="GER40">GER40 (DAX)</option>
              <option value="FRA40">FRA40 (CAC)</option>
              <option value="AUS200">AUS200</option>
              <option value="JPN225">JPN225 (Nikkei)</option>
              <option value="HK50">HK50 (Hang Seng)</option>
              <option value="ESP35">ESP35 (IBEX)</option>
            </optgroup>
          </select>
        </div>
        <div class="form-group">
          <label>Trading Strategy</label>
          <select id="botStrategy">
            <option value="MA">Moving Average</option>
            <option value="RSI">RSI Crossover</option>
            <option value="MACD">MACD</option>
            <option value="Grid">Grid Trading</option>
          </select>
        </div>
        <div class="form-group">
          <label>Volume per Trade</label>
          <input type="number" id="botVolume" value="0.2" min="0.01" step="0.01">
          <div class="form-helper">Minimum trade ‚âà $15 notional</div>
        </div>
        <div class="form-group">
          <label>Max Daily Trades</label>
          <input type="number" id="botMaxTrades" value="10" min="1" step="1">
        </div>
        <div class="form-group">
          <label>Take Profit (%)</label>
          <input type="number" id="botTakeProfit" value="2" min="0.1" step="0.1">
        </div>
        <div class="form-group">
          <label>Stop Loss (%)</label>
          <input type="number" id="botStopLoss" value="1" min="0.1" step="0.1">
        </div>
      </div>
      <div style="display:flex; gap:12px;">
        <button id="startBotBtn" class="action-btn btn-primary" style="flex:1;">‚ñ∂Ô∏è Start Bot</button>
        <button id="stopBotBtn" class="action-btn btn-danger" style="flex:1; opacity:0.5;" disabled>‚èπÔ∏è Stop Bot</button>
        <button id="resetBotBtn" class="action-btn btn-secondary" style="flex:1;">üîÑ Reset</button>
      </div>
    </section>

    <section class="content-card">
      <h3>Performance Statistics</h3>
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:15px;">
        <div class="stat-card">
          <div style="font-size:24px; font-weight:bold; color:var(--text-primary);" id="statTrades">0</div>
          <div style="font-size:12px; color:var(--text-tertiary); margin-top:5px;">Trades Executed</div>
        </div>
        <div class="stat-card">
          <div style="font-size:24px; font-weight:bold; color:var(--success);" id="statWins">0</div>
          <div style="font-size:12px; color:var(--text-tertiary); margin-top:5px;">Winning Trades</div>
        </div>
        <div class="stat-card">
          <div style="font-size:24px; font-weight:bold; color:var(--danger);" id="statLosses">0</div>
          <div style="font-size:12px; color:var(--text-tertiary); margin-top:5px;">Losing Trades</div>
        </div>
        <div class="stat-card">
          <div style="font-size:24px; font-weight:bold; color:var(--success);" id="statPnL">$0.00</div>
          <div style="font-size:12px; color:var(--text-tertiary); margin-top:5px;">Today's P&L</div>
        </div>
      </div>
    </section>

    <section class="content-card">
      <h3>Activity Log</h3>
      <div id="botLog" style="height:300px; overflow-y:auto; background:var(--bg-secondary); padding:15px; border-radius:var(--radius-md); border:1px solid var(--border-color); font-family:monospace; font-size:12px; color:var(--secondary);">
        Ready to start bot. Click "Start Bot" to begin automated trading...
      </div>
    </section>
  </main>

  <script src="storage.js"></script>
  <script src="sync-manager.js"></script>
  <script>
    let botRunning = false;
    let botStats = { trades: 0, wins: 0, losses: 0, pnl: 0 };
    let tradingAccount = 'demo'; // Track which account to trade with
    window.currentTradingAccount = 'demo'; // For sync manager

    function switchTradingAccount(account) {
      tradingAccount = account;
      window.currentTradingAccount = account; // Update for sync manager
      
      const demoBtn = document.getElementById('demoAccountBtn');
      const realBtn = document.getElementById('realAccountBtn');
      
      if (account === 'demo') {
        demoBtn.style.background = 'rgba(0, 212, 255, 0.15)';
        demoBtn.style.color = '#00d4ff';
        demoBtn.style.borderColor = '#00d4ff';
        
        realBtn.style.background = 'rgba(100, 100, 100, 0.1)';
        realBtn.style.color = '#999';
        realBtn.style.borderColor = 'transparent';
      } else {
        realBtn.style.background = 'rgba(255, 215, 0, 0.15)';
        realBtn.style.color = '#ffd700';
        realBtn.style.borderColor = '#ffd700';
        
        demoBtn.style.background = 'rgba(100, 100, 100, 0.1)';
        demoBtn.style.color = '#999';
        demoBtn.style.borderColor = 'transparent';
      }
      
      loadBalance();
      SyncManager.updateBalance(); // Sync balance display
      addLog('Switched to ' + (account === 'demo' ? 'Demo' : 'Real') + ' account for trading');
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (!storage.isLoggedIn()) {
        window.location.href = 'index.html';
        return;
      }

      const user = storage.getUser();
      if (user) {
        loadBalance();
      }

      // Refresh balance every 2 seconds to stay in sync with dashboard
      setInterval(loadBalance, 2000);

      document.getElementById('startBotBtn').addEventListener('click', startBot);
      document.getElementById('stopBotBtn').addEventListener('click', stopBot);
      document.getElementById('resetBotBtn').addEventListener('click', resetBot);

      setupMenuToggle();
    });

    function startBot() {
      botRunning = true;
      updateUI();
      addLog('ü§ñ Bot initialized with ' + document.getElementById('botStrategy').value + ' strategy...');
      addLog('üìä Trading ' + document.getElementById('botVolume').value + ' units of ' + document.getElementById('botPair').value);
      addLog('üí∞ Account: ' + (tradingAccount === 'demo' ? 'Demo' : 'Real'));
      addLog('üéØ Max trades today: ' + document.getElementById('botMaxTrades').value);

      // Enforce approximate $15 minimum trade notional (only for real account)
      const vol = parseFloat(document.getElementById('botVolume').value) || 0;
      // Approximate notional using 100 as base for FX lot proxy if price unavailable
      const approxNotional = vol * 100;
      if (tradingAccount === 'real' && approxNotional < 15) {
        botRunning = false;
        updateUI();
        addLog('‚ùå Minimum trade amount for real account is $15. Increase volume.');
        return;
      }
      
      // Demo account can trade any amount
      if (tradingAccount === 'demo') {
        addLog('‚úÖ Demo account - no minimum restrictions');
      }

      simulateBotTrade();
    }

    function simulateBotTrade() {
      if (!botRunning) return;

      const pair = document.getElementById('botPair').value;
      const volume = parseFloat(document.getElementById('botVolume').value);
      // Block trades below $15 notional for real account only
      if (tradingAccount === 'real' && (volume * 100) < 15) { 
        addLog('‚ö†Ô∏è Skipped trade: below $15 minimum for real account'); 
        setTimeout(simulateBotTrade, 3000); 
        return; 
      }
      const strategy = document.getElementById('botStrategy').value;
      const tradeType = Math.random() > 0.5 ? 'BUY' : 'SELL';
      const currentBalance = storage.getBalance(tradingAccount);

      addLog('[' + strategy + '] Signal generated - ' + tradeType + ' ' + volume + ' ' + pair);

      setTimeout(() => {
        if (!botRunning) return;
        
        const profit = (Math.random() > 0.4) ? parseFloat((Math.random() * 100 + 50).toFixed(2)) : parseFloat((-(Math.random() * 100 + 25)).toFixed(2));
        const newBalance = currentBalance + profit;
        
        // Update balance using storage module with sync
        storage.setBalance(newBalance, tradingAccount);
        SyncManager.triggerSync(); // Sync to all open pages
        
        // Also save to accountData format for compatibility with dashboard
        const accountData = JSON.parse(localStorage.getItem('accountData_' + tradingAccount) || '{"balance":10000,"equity":10000,"pnl":0}');
        accountData.balance = newBalance;
        accountData.equity = newBalance;
        accountData.pnl = (accountData.pnl || 0) + profit;
        localStorage.setItem('accountData_' + tradingAccount, JSON.stringify(accountData));
        
        // Add to trade history
        storage.addTrade({
          id: Date.now() + '_bot',
          pair: pair,
          type: tradeType,
          amount: volume,
          profit: profit,
          openTime: new Date().toISOString(),
          closeTime: new Date().toISOString(),
          account: tradingAccount,
          result: profit >= 0 ? 'win' : 'loss',
          strategy: strategy
        });
        
        // Add transaction record
        storage.addTransaction({
          id: Date.now() + '_bot_trade',
          type: 'bot_trade',
          pair: pair,
          tradeType: tradeType,
          amount: volume,
          profit: profit,
          timestamp: new Date().toISOString(),
          account: tradingAccount,
          status: 'completed'
        });
        
        if (profit > 0) {
          botStats.wins++;
          addLog('‚úÖ Trade closed with PROFIT: +$' + profit.toFixed(2) + ' (Balance: $' + newBalance.toFixed(2) + ')');
        } else {
          botStats.losses++;
          addLog('‚ùå Trade closed with LOSS: $' + profit.toFixed(2) + ' (Balance: $' + newBalance.toFixed(2) + ')');
        }
        
        botStats.trades++;
        botStats.pnl += profit;
        updateStats();
        loadBalance();

        if (botRunning && botStats.trades < parseInt(document.getElementById('botMaxTrades').value)) {
          setTimeout(simulateBotTrade, 3000);
        } else if (botStats.trades >= parseInt(document.getElementById('botMaxTrades').value)) {
          addLog('‚èπÔ∏è Maximum daily trades reached. Bot stopping...');
          stopBot();
        }
      }, 2000);
    }

    function stopBot() {
      botRunning = false;
      updateUI();
      addLog('‚èπÔ∏è Bot stopped');
    }

    function resetBot() {
      botStats = { trades: 0, wins: 0, losses: 0, pnl: 0 };
      document.getElementById('botLog').textContent = 'üîÑ Bot reset. Ready to start trading...';
      updateStats();
    }

    function addLog(message) {
      const logEl = document.getElementById('botLog');
      const time = new Date().toLocaleTimeString();
      const logEntry = '\n[' + time + '] ' + message;
      logEl.textContent += logEntry;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateStats() {
      document.getElementById('statTrades').textContent = botStats.trades;
      document.getElementById('statWins').textContent = botStats.wins;
      document.getElementById('statLosses').textContent = botStats.losses;
      document.getElementById('statPnL').textContent = '$' + botStats.pnl.toFixed(2);
    }

    function updateUI() {
      document.getElementById('startBotBtn').disabled = botRunning;
      document.getElementById('stopBotBtn').disabled = !botRunning;
      document.getElementById('botPair').disabled = botRunning;
      document.getElementById('botVolume').disabled = botRunning;
      document.getElementById('botStrategy').disabled = botRunning;

      const statusEl = document.getElementById('botStatusText');
      if (botRunning) {
        statusEl.textContent = 'Running';
        statusEl.style.color = 'var(--success)';
      } else {
        statusEl.textContent = 'Stopped';
        statusEl.style.color = 'var(--danger)';
      }
    }

    function loadBalance() {
      let balance;
      const user = storage.getUser();
      
      // FOR MARKETERS: Load from marketers array (this is the key fix!)
      if (user && tradingAccount === 'real') {
        const marketers = JSON.parse(localStorage.getItem('marketers') || '[]');
        const marketer = marketers.find(m => m.email === user.email);
        if (marketer && marketer.isMarketer) {
          balance = marketer.balance || 0;
        } else {
          balance = storage.getBalance(tradingAccount);
        }
      } else {
        balance = storage.getBalance(tradingAccount);
      }
      
      document.getElementById('balance').textContent = '$' + parseFloat(balance).toLocaleString('en-US', {minimumFractionDigits: 2});
      document.getElementById('tradingAccountBalance').textContent = '$' + parseFloat(balance).toLocaleString('en-US', {minimumFractionDigits: 2});
    }

    function setupMenuToggle() {
      const menuToggle = document.getElementById('menuToggle');
      const sideMenu = document.getElementById('sideMenu');
      const menuClose = document.querySelector('.menu-close');
      const logout = document.querySelector('.logout');
      const toggleMode = document.getElementById('toggleMode');

      if (menuToggle) menuToggle.addEventListener('click', () => sideMenu?.classList.add('active'));
      if (menuClose) menuClose.addEventListener('click', () => sideMenu?.classList.remove('active'));
      if (logout) logout.addEventListener('click', (e) => {
        e.preventDefault();
        storage.removeUser();
        window.location.href = 'index.html';
      });
      if (toggleMode) toggleMode.addEventListener('click', () => {
        document.body.classList.toggle('light-mode');
        localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
      });

      if (localStorage.getItem('theme') === 'light') {
        document.body.classList.add('light-mode');
      }
    }
  </script>
</body>
</html>
